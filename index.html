<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const captureBtn = document.getElementById('captureBtn');
const saveControls = document.getElementById('saveControls');
const filenameInput = document.getElementById('filename');
const saveBtn = document.getElementById('saveBtn');
const newBtn = document.getElementById('newBtn');

const toast = document.createElement('div');
toast.style.position = 'fixed';
toast.style.bottom = '20px';
toast.style.left = '50%';
toast.style.transform = 'translateX(-50%)';
toast.style.background = '#333';
toast.style.color = '#fff';
toast.style.padding = '10px 20px';
toast.style.borderRadius = '8px';
toast.style.display = 'none';
document.body.appendChild(toast);

function showToast(message) {
  toast.textContent = message;
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', 2000);
}

// Inicia cámara trasera
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } },
      audio: false
    });
    video.srcObject = stream;
  } catch (err) {
    alert("No se pudo acceder a la cámara: " + err);
  }
}

function drawRotatedImage() {
  const ctx = canvas.getContext('2d');

  const w = video.videoWidth;
  const h = video.videoHeight;
  const isLandscape = window.innerWidth > window.innerHeight;

  if (isLandscape) {
    // Ajusta canvas para apaisado
    canvas.width = h;
    canvas.height = w;
    ctx.save();
    ctx.translate(h / 2, w / 2);
    ctx.rotate(-90 * Math.PI / 180);
    ctx.drawImage(video, -w / 2, -h / 2);
    ctx.restore();
  } else {
    canvas.width = w;
    canvas.height = h;
    ctx.drawImage(video, 0, 0);
  }
}

captureBtn.onclick = () => {
  drawRotatedImage();
  video.style.display = 'none';
  canvas.style.display = 'block';
  captureBtn.style.display = 'none';
  saveControls.style.display = 'block';
};

saveBtn.onclick = () => {
  const name = filenameInput.value.trim() || 'foto';
  const link = document.createElement('a');
  link.download = name + '.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
  showToast('Foto guardada');
};

newBtn.onclick = () => {
  video.style.display = 'block';
  canvas.style.display = 'none';
  captureBtn.style.display = 'inline-block';
  saveControls.style.display = 'none';
  filenameInput.value = '';
};

startCamera();
</script>
